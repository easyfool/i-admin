<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>菜单列表</title>
        <!-- Bootstrap 3.3.7 -->
        <link rel="stylesheet" th:href="@{/vendor/bootstrap/v3.3.7/prod/css/bootstrap.min.css}">
        <link rel="stylesheet" th:href="@{/vendor/bootstrap-table/v1.15.4/bootstrap-table.min.css}">
        <!-- Font Awesome -->
        <link rel="stylesheet" th:href="@{/vendor/font-awesome/v4.7.0/css/font-awesome.min.css}">
        <!---树形表格-->
        <link rel="stylesheet" th:href="@{/vendor/jquery-treegrid/v0.2.0/css/jquery.treegrid.css}">
    </head>
    <body>

        <div class="container">
            <!--            <h1>树形表格 ： Table Treegrid</h1>-->
            <table id="table_menu_list"></table>
            <br/>

          <div id="modal_add_menu" class="modal fade" tabindex="-1" role="dialog">
<!--                <input id="txt_modal_type" name="modalType" hidden/>-->
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title">新增菜单</h4>
                        </div>
                        <div class="modal-body">

                            <form id="form_add_menu_detail">
                                <input id="txt__add_parentId" name="parentId" hidden/>
                                <div class="form-group">
                                    <label for="txt_menuName">菜单名称</label>
                                    <input name="name" type="text" class="form-control"
                                           placeholder="menuName">
                                </div>
                                <div class="form-group">
                                    <label for="txt_MenuUrl">url</label>
                                    <input name="url" type="text" class="form-control"
                                           placeholder="url">
                                </div>
                                <div class="form-group">
                                    <label for="txt_icon">图标</label>
                                    <input name="icon" type="text" class="form-control"  placeholder="图标">
                                </div>
                                <div class="form-group">
                                    <label for="txt_permission">权限</label>
                                    <input name="permission" type="text" class="form-control"
                                           placeholder="权限">
                                </div>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button id="btn_modal_add_submit_menu" type="button" class="btn btn-primary">保存</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
          <div id="modal_update_menu" class="modal fade" tabindex="-1" role="dialog">
            <!--                <input id="txt_modal_type" name="modalType" hidden/>-->
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  <h4 class="modal-title">更新菜单</h4>
                </div>
                <div class="modal-body">

                  <form id="form_update_menu_detail">
                    <input id="txt_update_parentId" name="parentId" hidden/>
                    <input id="txt_menuId" name="id" hidden/>
                    <div class="form-group">
                      <label for="txt_menuName">菜单名称</label>
                      <input name="name" type="text" class="form-control" id="txt_menuName"
                          placeholder="menuName">
                    </div>
                    <div class="form-group">
                      <label for="txt_MenuUrl">url</label>
                      <input name="url" type="text" class="form-control" id="txt_MenuUrl"
                          placeholder="url">
                    </div>
                    <div class="form-group">
                      <label for="txt_icon">图标</label>
                      <input name="icon" type="text" class="form-control" id="txt_icon" placeholder="图标">
                    </div>
                    <div class="form-group">
                      <label for="txt_permission">权限</label>
                      <input name="permission" type="text" class="form-control" id="txt_permission"
                          placeholder="权限">
                    </div>
                  </form>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button id="btn_modal_update_submit_menu" type="button" class="btn btn-primary">保存</button>

                </div>
              </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->
            <!--            <button onclick="test()">选择</button>-->
        </div>


    </body>
    <footer>
        <!-- jQuery 3 -->
        <script th:src="@{/vendor/jquery/v1.12.4/jquery-1.12.4.min.js}"></script>
        <!-- jQuery UI 1.11.4 -->
        <!--        <script th:src="@{/vendor/jquery-ui/jquery-ui.min.js}"></script>-->
        <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
        <!-- Bootstrap 3.3.7 -->
        <script th:src="@{/vendor/bootstrap/v3.3.7/prod/js/bootstrap.min.js}"></script>
        <script th:src="@{/vendor/bootstrap-table/v1.15.4/bootstrap-table.min.js}"></script>
        <script th:src="@{/vendor/bootstrap-table/v1.15.4/locale/bootstrap-table-zh-CN.min.js}"></script>
        <script th:src="@{/vendor/bootstrap-table/v1.15.4/extensions/treegrid/bootstrap-table-treegrid.min.js}"></script>
        <script th:src="@{/vendor/jquery-treegrid/v0.2.0/js/jquery.treegrid.js}"></script>

        <script th:src="@{/js/formSerializeToJson.js}"></script>

        <script type="text/javascript">

            var data = JSON.parse(
                '[{"id":1,"pid":0,"status":1,"name":"用户管理","permissionValue":"open:user:manage"},' +
                '{"id":2,"pid":0,"status":1,"name":"系统管理","permissionValue":"open:system:manage"},' +
                '{"id":3,"pid":1,"status":1,"name":"新增用户","permissionValue":"open:user:add"},' +
                '{"id":4,"pid":1,"status":1,"name":"修改用户","permissionValue":"open:user:edit"},' +
                '{"id":5,"pid":1,"status":0,"name":"删除用户","permissionValue":"open:user:del"},' +
                '{"id":6,"pid":2,"status":1,"name":"系统配置管理","permissionValue":"open:systemconfig:manage"},' +
                '{"id":7,"pid":6,"status":1,"name":"新增配置","permissionValue":"open:systemconfig:add"},' +
                '{"id":8,"pid":6,"status":1,"name":"修改配置","permissionValue":"open:systemconfig:edit"},' +
                '{"id":9,"pid":6,"status":0,"name":"删除配置","permissionValue":"open:systemconfig:del"},' +
                '{"id":10,"pid":2,"status":1,"name":"系统日志管理","permissionValue":"open:log:manage"},' +
                '{"id":11,"pid":10,"status":1,"name":"新增日志","permissionValue":"open:log:add"},' +
                '{"id":12,"pid":10,"status":1,"name":"修改日志","permissionValue":"open:log:edit"},' +
                '{"id":13,"pid":10,"status":0,"name":"删除日志","permissionValue":"open:log:del"}]');

            $(function () {

                //控制台输出一下数据
                var $table = $('#table_menu_list');
                // console.log(data);
                $table.bootstrapTable('destroy');
                $table.bootstrapTable({
                    url: "/sys/admin/menu/listMenus",
                    // type: "POST",
                    // data:data,
                    // contentType:"application/x-www-form-urlencoded; charset=UTF-8",
                    idField: 'id',
                    // uniqueId:"id",
                    // dataType:'jsonp',
                    columns: [
                        {
                            field: 'check', checkbox: true, formatter: function (value, row, index) {
                                if (row.check == true) {
                                    // console.log(row.serverName);
                                    //设置选中
                                    return {checked: true};
                                }
                            }
                        },
                        {field: 'id', title: '主键',hidden:true},
                        {field: 'name', title: '名称'},
                        {field: 'url', title: '链接(Href)'},
                        {field: 'level', title: '层级'},
                        {field: 'id', title: '编号', sortable: true, align: 'center'},
                        {field: 'parentId', title: '上级菜单'},
                        {field: 'status', title: '状态', sortable: true, align: 'center', formatter: 'statusFormatter'},
                        {field: 'permission', title: '权限值'},
                        {
                            field: 'operate',
                            title: '操作',
                            align: 'center',
                            events: operateEvents,
                            formatter: 'operateFormatter'
                        },
                    ],

                    // bootstrap-table-treegrid.js 插件配置 -- start

                    // //在哪一列展开树形
                    treeShowField: 'name',
                    // //指定父id列
                    parentIdField: 'parentId',

                    onResetView: function (data) {

                      // $("#table_menu_list").bootstrapTable('hideRow', {
                      //   index: 1
                      // });
                        //console.log('load');
                        $table.treegrid({
                            initialState: 'collapsed',// 所有节点都折叠
                            // initialState: 'expanded',// 所有节点都展开，默认展开
                            treeColumn: 1,
                            // expanderExpandedClass: 'glyphicon glyphicon-minus',  //图标样式
                            // expanderCollapsedClass: 'glyphicon glyphicon-plus',
                            onChange: function () {
                                $table.bootstrapTable('resetWidth');
                            }
                        });
                      // $("#table_menu_list").bootstrapTable('hideRow', {
                      //   index: 1
                      // });
                        //只展开树形的第一级节点
                        $table.treegrid('getRootNodes').treegrid('expand');

                    },
                    onCheck: function (row) {
                        var datas = $table.bootstrapTable('getData');
                        // 勾选子类
                        selectChilds(datas, row, "id", "parentId", true);

                        // 勾选父类
                        selectParentChecked(datas, row, "id", "parentId")

                        // 刷新数据
                        $table.bootstrapTable('load', datas);
                    },

                    onUncheck: function (row) {
                        var datas = $table.bootstrapTable('getData');
                        selectChilds(datas, row, "id", "parentId", false);
                        $table.bootstrapTable('load', datas);
                    }
                    // bootstrap-table-treetreegrid.js 插件配置 -- end
                });


              // $('#table_menu_list').bootstrapTable('hideRow', { index:1 });

              // $("#button2").click(function() {
              //   $("#table_menu_list").bootstrapTable('hideRow', {
              //     index: 1
              //   })
              // })
              //
              // $("#table_menu_list").bootstrapTable('hideRow', {index: 1});


                $("#btn_modal_add_submit_menu").click(function () {
                    var menuJsonObj = $("#form_add_menu_detail").serializeFormJSON();
                    console.log("保存按钮数据：" + JSON.stringify(menuJsonObj));
                  addMenuData(menuJsonObj);
                });

              $("#btn_modal_update_submit_menu").click(function () {
                var menuJsonObj = $("#form_update_menu_detail").serializeFormJSON();
                console.log("更新数据：" + JSON.stringify(menuJsonObj));
                updateMenuData(menuJsonObj);
              });
            });

            /**
             * 保存按钮数据
             * @param menu
             */
            function addMenuData(menu) {
                $.ajax({
                    type: "post",
                    url: "/sys/admin/menu/add",
                    data: JSON.stringify(menu),
                    contentType: "application/json",
                    // contentType: "application/json",
                    // dataType: "json",
                    success: function (response) {
                        console.log("menu 新增成功." + JSON.stringify(response));
                        $("#modal_add_menu").modal("hide");
                        $("#table_menu_list").bootstrapTable('refresh');
                    }
                });
            }

            /**
             * 保存按钮数据
             * @param menu
             */
            function updateMenuData(menu) {
                $.ajax({
                    type: "post",
                    url: "/sys/admin/menu/update",
                    data: JSON.stringify(menu),
                    contentType: "application/json",
                    // contentType: "application/json",
                    // dataType: "json",
                    success: function (response) {
                        console.log("menu 新增成功." + JSON.stringify(response));
                        $("#modal_edit_menu").modal("hide");
                        $("#table_menu_list").bootstrapTable('refresh');
                    }
                });
            }

            // 格式化按钮
            function operateFormatter(value, row, index) {


                var addOperation = '<button type="button" class="RoleOfadd btn-small  btn-primary" style="margin-right:15px;"><i class="fa fa-plus" ></i>&nbsp;新增</button>';
                var updateOperation = '<button type="button" class="RoleOfedit btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-pencil-square-o" ></i>&nbsp;修改</button>';
                var removeOperation = '<button type="button" class="RoleOfdelete btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-trash-o" ></i>&nbsp;删除</button>';
                var operations = [addOperation, updateOperation];
                if(row.level!==1){
                    operations.push(removeOperation);
                }
                return operations.join('');
                // return [
                //     '<button type="button" class="RoleOfadd btn-small  btn-primary" style="margin-right:15px;"><i class="fa fa-plus" ></i>&nbsp;新增</button>',
                //     '<button type="button" class="RoleOfedit btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-pencil-square-o" ></i>&nbsp;修改</button>',
                //     '<button type="button" class="RoleOfdelete btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-trash-o" ></i>&nbsp;删除</button>'
                // ].join('');



            }

            // 格式化类型
            function typeFormatter(value, row, index) {
                if (value === 'menu') {
                    return '菜单';
                }
                if (value === 'button') {
                    return '按钮';
                }
                if (value === 'api') {
                    return '接口';
                }
                return '-';
            }

            // 格式化状态
            function statusFormatter(value, row, index) {
                if (value === 0) {
                    return '<span class="label label-success">正常</span>';
                } else {
                    return '<span class="label label-default">锁定</span>';
                }
            }

            //初始化操作按钮的方法
            window.operateEvents = {
                'click .RoleOfadd': function (e, value, row, index) {
                    add(row.id);
                },
                'click .RoleOfdelete': function (e, value, row, index) {
                    del(row.id);
                },
                'click .RoleOfedit': function (e, value, row, index) {
                    console.log("row:" + row.name);
                    update(row);
                }
            };
        </script>
        <script>
            /**
             * 选中父项时，同时选中子项
             * @param datas 所有的数据
             * @param row 当前数据
             * @param id id 字段名
             * @param pid 父id字段名
             */
            function selectChilds(datas, row, id, pid, checked) {
                for (var i in datas) {
                    if (datas[i][pid] == row[id]) {
                        datas[i].check = checked;
                        selectChilds(datas, datas[i], id, pid, checked);
                    }
                    ;
                }
            }

            function selectParentChecked(datas, row, id, pid) {
                for (var i in datas) {
                    if (datas[i][id] == row[pid]) {
                        datas[i].check = true;
                        selectParentChecked(datas, datas[i], id, pid);
                    }
                    ;
                }
            }

            function test() {
                var $table = $('#table_menu_list');
                var selRows = $table.bootstrapTable("getSelections");
                if (selRows.length == 0) {
                    alert("请至少选择一行");
                    return;
                }

                var postData = "";
                $.each(selRows, function (i) {
                    postData += this.id;
                    if (i < selRows.length - 1) {
                        postData += "， ";
                    }
                });
                alert("你选中行的 id 为：" + postData);

            }

            function add(id) {
                $("#txt__add_parentId").val(id);
                $("#modal_add_menu").modal("show");
            }

            function del(id) {
              // alert("del 方法 , id = " + id);
              $.ajax({
                type: "GET",
                url: "/sys/admin/menu/delete/" + id,
                success: function (response) {
                  console.log("menu 删除成功." + JSON.stringify(response));
                  // $("#table_menu_list").bootstrapTable('refresh');
                  $('#table_menu_list').bootstrapTable('remove', {
                    field: "id",   //此处的 “id”对应的是字段名
                    values: [parseInt(id)]
                  });
                }
              });

            }

            function update(row) {
                console.log(row.name);
                $("#txt_menuId").val(row.id);
                $("#txt_update_parentId").val(row.parentId);
                $("#txt_menuName").val(row.name);
                $("#txt_menuUrl").val(row.url);
                $("#txt_icon").val(row.icon);
                $("#txt_permission").val(row.permission);
                // $("#form_update_menu_detail .modal-title").html("更新菜单");
                $("#modal_update_menu").modal("show");
            }


        </script>
    </footer>
</html>